<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiration Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üîî Expiration Tracker</h1>
                    <p class="text-gray-600 mt-1">Monitor item expiration dates with Telegram alerts</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="manualCheckAlerts()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                        üîî Check Alerts Now
                    </button>
                    <button onclick="toggleSettings()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">
                        ‚öôÔ∏è Settings
                    </button>
                    <button onclick="toggleForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                        ‚ûï Add Item
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settingsPanel" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Telegram Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Bot Token</label>
                    <input type="text" id="botToken" class="w-full border rounded-lg px-3 py-2" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Chat ID</label>
                    <input type="text" id="chatId" class="w-full border rounded-lg px-3 py-2" placeholder="123456789">
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        Save Configuration
                    </button>
                    <button onclick="testAlert()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        üîî Test Alert
                    </button>
                    <button onclick="showDebugInfo()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                        üêõ Debug Info
                    </button>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        üì• Export Database
                    </button>
                    <label class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg cursor-pointer">
                        üì§ Import Database
                        <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                    </label>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-sm">
                    <p class="font-semibold mb-2">Setup Instructions:</p>
                    <ol class="list-decimal ml-5 space-y-1">
                        <li>Create a bot via @BotFather on Telegram</li>
                        <li>Copy the Bot Token and paste above</li>
                        <li>Get your Chat ID from @userinfobot</li>
                        <li>Start a chat with your bot first, then test the alert</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Add Item Form -->
        <div id="addItemForm" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Add New Item</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Item Name *</label>
                    <input type="text" id="itemName" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Cost</label>
                    <input type="number" step="0.01" id="itemCost" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Alert Days Before Expiry *</label>
                    <input type="number" id="alertDays" class="w-full border rounded-lg px-3 py-2" min="1" value="7">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Supplier</label>
                    <input type="text" id="itemSupplier" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Expiration Date *</label>
                    <input type="date" id="itemExpiry" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Quantity</label>
                    <input type="text" id="itemQuantity" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Store Location</label>
                    <input type="text" id="itemLocation" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="col-span-2 flex gap-2">
                    <button onclick="addItem()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">
                        Add Item
                    </button>
                    <button onclick="toggleForm()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Items Database -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìä Items Database (<span id="itemCount">0</span>)</h2>
            <div id="emptyState" class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4 opacity-50">üîî</div>
                <p>No items tracked yet. Add your first item to get started!</p>
            </div>
            <div id="itemsTable" class="overflow-x-auto hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Item Name</th>
                            <th class="px-4 py-2 text-left">Cost</th>
                            <th class="px-4 py-2 text-left">Supplier</th>
                            <th class="px-4 py-2 text-left">Expiry Date</th>
                            <th class="px-4 py-2 text-left">Alert Days</th>
                            <th class="px-4 py-2 text-left">Quantity</th>
                            <th class="px-4 py-2 text-left">Location</th>
                            <th class="px-4 py-2 text-center">Status</th>
                            <th class="px-4 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let config = { botToken: '', chatId: '' };

        // Initialize
        function init() {
            loadData();
        }

        // Load data
        function loadData() {
            const savedItems = localStorage.getItem('expiry-items');
            const savedConfig = localStorage.getItem('telegram-config');

            if (savedItems) items = JSON.parse(savedItems);
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                document.getElementById('botToken').value = config.botToken || '';
                document.getElementById('chatId').value = config.chatId || '';
            }

            renderItems();
        }

        // Save data
        function saveItems() {
            localStorage.setItem('expiry-items', JSON.stringify(items));
            renderItems();
        }

        function saveConfig() {
            config = {
                botToken: document.getElementById('botToken').value,
                chatId: document.getElementById('chatId').value
            };
            localStorage.setItem('telegram-config', JSON.stringify(config));
            alert('‚úÖ Configuration saved successfully!');
        }

        // Toggle UI
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function toggleForm() {
            document.getElementById('addItemForm').classList.toggle('hidden');
        }

        // Add item
        function addItem() {
            const name = document.getElementById('itemName').value;
            const expiry = document.getElementById('itemExpiry').value;
            const alertDays = document.getElementById('alertDays').value;

            if (!name || !expiry || !alertDays) {
                alert('Please fill in Item Name, Expiration Date, and Alert Days');
                return;
            }

            const newItem = {
                id: Date.now(),
                name: name,
                cost: document.getElementById('itemCost').value,
                supplier: document.getElementById('itemSupplier').value,
                expiryDate: expiry,
                alertDays: parseInt(alertDays),
                quantity: document.getElementById('itemQuantity').value,
                location: document.getElementById('itemLocation').value,
                addedDate: new Date().toISOString()
            };

            items.push(newItem);
            saveItems();

            // Clear form
            document.getElementById('itemName').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemSupplier').value = '';
            document.getElementById('itemExpiry').value = '';
            document.getElementById('alertDays').value = '7';
            document.getElementById('itemQuantity').value = '';
            document.getElementById('itemLocation').value = '';
            toggleForm();
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('Delete this item?')) {
                items = items.filter(item => item.id !== id);
                saveItems();
            }
        }

        // Calculate days until expiry
        function getDaysUntilExpiry(expiryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            return Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        }

        // Get alert status - now uses item-specific alertDays
        function getAlertStatus(item) {
            const days = getDaysUntilExpiry(item.expiryDate);
            const alertThreshold = item.alertDays || 7; // Default to 7 if not set
            
            if (days < 0) return { color: 'text-red-600', bg: 'bg-red-50', label: 'EXPIRED' };
            if (days === 0) return { color: 'text-red-600', bg: 'bg-red-50', label: 'EXPIRES TODAY' };
            if (days <= alertThreshold) return { color: 'text-orange-600', bg: 'bg-orange-50', label: `${days}d` };
            return { color: 'text-green-600', bg: 'bg-green-50', label: `${days}d` };
        }

        // Render items
        function renderItems() {
            document.getElementById('itemCount').textContent = items.length;

            if (items.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('itemsTable').classList.add('hidden');
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('itemsTable').classList.remove('hidden');

            // Sort by days until expiry
            const sortedItems = [...items].sort((a, b) => 
                getDaysUntilExpiry(a.expiryDate) - getDaysUntilExpiry(b.expiryDate)
            );

            const tbody = document.getElementById('itemsBody');
            tbody.innerHTML = sortedItems.map(item => {
                const status = getAlertStatus(item);
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${item.name}</td>
                        <td class="px-4 py-3">${item.cost ? '‚Ç±' + item.cost : '-'}</td>
                        <td class="px-4 py-3">${item.supplier || '-'}</td>
                        <td class="px-4 py-3">${item.expiryDate}</td>
                        <td class="px-4 py-3">${item.alertDays || 7} days</td>
                        <td class="px-4 py-3">${item.quantity || '-'}</td>
                        <td class="px-4 py-3">${item.location || '-'}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="${status.bg} ${status.color} px-3 py-1 rounded-full text-sm font-semibold">
                                ${status.label}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Debug function
        function showDebugInfo() {
            let info = 'üêõ DEBUG INFORMATION\n\n';
            info += '‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê\n';
            info += `Bot Token: ${config.botToken ? '‚úì Set (length: ' + config.botToken.length + ')' : '‚úó NOT SET'}\n`;
            info += `Chat ID: ${config.chatId ? '‚úì Set (' + config.chatId + ')' : '‚úó NOT SET'}\n\n`;
            info += `‚ïê‚ïê‚ïê ITEMS (${items.length}) ‚ïê‚ïê‚ïê\n`;
            
            if (items.length === 0) {
                info += 'No items added yet.\n';
            } else {
                items.forEach((item, index) => {
                    const days = getDaysUntilExpiry(item.expiryDate);
                    const alertThreshold = item.alertDays || 7;
                    const isInRange = days <= alertThreshold && days >= 0;
                    info += `\n${index + 1}. ${item.name}\n`;
                    info += `   Expiry: ${item.expiryDate}\n`;
                    info += `   Days left: ${days}\n`;
                    info += `   Alert threshold: ${alertThreshold} days\n`;
                    info += `   Will alert: ${isInRange ? '‚úì YES - WITHIN RANGE' : '‚úó NO'}\n`;
                });
            }
            
            alert(info);
        }

        // Telegram functions
        async function sendTelegramMessage(message) {
            if (!config.botToken || !config.chatId) {
                alert('‚ö†Ô∏è Please configure Telegram settings first!\n\nGo to Settings and add your Bot Token and Chat ID.');
                return false;
            }

            try {
                const response = await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: config.chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                const data = await response.json();
                
                if (!data.ok) {
                    alert(`‚ùå Telegram Error: ${data.description || 'Unknown error'}\n\nPlease check:\n1. Your Bot Token is correct\n2. Your Chat ID is correct\n3. You've started a chat with your bot`);
                    return false;
                }
                
                return true;
            } catch (error) {
                alert(`‚ùå Connection Error: ${error.message}\n\nPlease check your internet connection.`);
                return false;
            }
        }

        async function testAlert() {
            const success = await sendTelegramMessage('üß™ Test alert from Expiration Tracker\n\nYour Telegram integration is working correctly!');
            if (success) {
                alert('‚úÖ Test message sent successfully!\n\nCheck your Telegram to confirm you received it.');
            }
        }

        async function manualCheckAlerts() {
            if (!config.botToken || !config.chatId) {
                alert('‚ö†Ô∏è Telegram not configured!\n\nPlease configure your Bot Token and Chat ID first.');
                return;
            }

            // Filter items based on their individual alertDays
            const alertItems = items.filter(item => {
                const days = getDaysUntilExpiry(item.expiryDate);
                const alertThreshold = item.alertDays || 7;
                return days <= alertThreshold && days >= 0;
            });

            const expiredItems = items.filter(item => getDaysUntilExpiry(item.expiryDate) < 0);

            if (alertItems.length === 0 && expiredItems.length === 0) {
                alert('‚úÖ No alerts needed!\n\nAll items are within safe expiration dates.');
                return;
            }

            // Sort items by store location
            const sortByLocation = (a, b) => {
                const locA = (a.location || 'N/A').toLowerCase();
                const locB = (b.location || 'N/A').toLowerCase();
                return locA.localeCompare(locB);
            };

            const sortedExpiredItems = [...expiredItems].sort(sortByLocation);
            const sortedAlertItems = [...alertItems].sort(sortByLocation);

            let message = '<b>Expiration Alert</b>\n\n';
            let totalValue = 0;
            
            if (sortedExpiredItems.length > 0) {
                message += '<b>Expired Items:</b>\n';
                message += '<i>(Sorted by Store Location)</i>\n\n';
                
                sortedExpiredItems.forEach(item => {
                    const itemCost = parseFloat(item.cost) || 0;
                    totalValue += itemCost;
                    message += `<b>Store Location:</b> ${item.location || 'N/A'}\n`;
                    message += `<b>Item Name:</b> ${item.name}\n`;
                    message += `<b>Quantity:</b> ${item.quantity || 'N/A'}\n`;
                    message += `<b>Amount:</b> ${itemCost > 0 ? '‚Ç±' + itemCost.toFixed(2) : 'N/A'}\n`;
                    message += `<b>Expiration Date:</b> ${item.expiryDate}\n`;
                    message += `<b>Supplier:</b> ${item.supplier || 'N/A'}\n\n`;
                });
            }

            if (sortedAlertItems.length > 0) {
                message += '<b>Items Expiring Soon:</b>\n';
                message += '<i>(Sorted by Store Location)</i>\n\n';
                
                sortedAlertItems.forEach(item => {
                    const itemCost = parseFloat(item.cost) || 0;
                    totalValue += itemCost;
                    message += `<b>Store Location:</b> ${item.location || 'N/A'}\n`;
                    message += `<b>Item Name:</b> ${item.name}\n`;
                    message += `<b>Quantity:</b> ${item.quantity || 'N/A'}\n`;
                    message += `<b>Amount:</b> ${itemCost > 0 ? '‚Ç±' + itemCost.toFixed(2) : 'N/A'}\n`;
                    message += `<b>Expiration Date:</b> ${item.expiryDate}\n`;
                    message += `<b>Supplier:</b> ${item.supplier || 'N/A'}\n\n`;
                });
            }

            const success = await sendTelegramMessage(message);
            if (success) {
                alert('‚úÖ Alert sent successfully!');
            }
        }

        // Export/Import
        function exportData() {
            const data = {
                items: items,
                telegramConfig: config,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expiry-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items) {
                        items = data.items;
                        saveItems();
                    }
                    if (data.telegramConfig) {
                        config = data.telegramConfig;
                        localStorage.setItem('telegram-config', JSON.stringify(config));
                        document.getElementById('botToken').value = config.botToken || '';
                        document.getElementById('chatId').value = config.chatId || '';
                    }
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>